<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="https://i.imgur.com/fVyAd9E.jpeg">
<link rel="apple-touch-icon" href="https://i.imgur.com/fVyAd9E.jpeg">
<meta name="theme-color" content="#1e90ff">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player</title>

<style>
:root{
  --card:#181b22;
  --primary:#1db954;
  --accent:#00b0ff;
  --text:#eaeaea;
  --muted:#9aa0a6;
  --radius:14px;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,#0c0f14,#12151c);
  color:var(--text);
  min-height:100vh;
  display:flex;
  justify-content:center;
}

.app{
  width:100%;
  max-width:760px;
  padding:14px;
}

.top-menu{
  display:flex;
  gap:10px;
  margin-bottom:14px;
}

.top-menu button{flex:1;}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}

h1{
  margin:0 0 12px 0;
  font-size:20px;
  text-align:center;
  color:var(--accent);
}

.buttons{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}

button{
  background:#232735;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:10px 14px;
  font-size:14px;
  cursor:pointer;
}

button:hover{
  background:var(--primary);
  color:#07150c;
}

#musicList{
  display:flex;
  flex-direction:column;
  gap:10px;
  max-height:300px;
  overflow:auto;
  margin-top:10px;
}

.music-item{
  position:relative;
  padding:10px 12px 14px 12px;
  border-radius:10px;
  background:#20242f;
  cursor:pointer;
  border-left:4px solid transparent;
  overflow:hidden;
}

.music-item.playing{
  background:#1db954;
  color:#07150c;
  border-left:4px solid #00ff8c;
  box-shadow:0 0 12px rgba(29,185,84,.45);
}

.music-title{font-weight:600}

.music-author{
  font-size:12px;
  color:var(--muted);
}

.music-item.playing .music-author{
  color:#062413;
}

/* barra de progresso da lista */
.item-progress{
  position:absolute;
  left:0;
  bottom:0;
  height:4px;
  width:0%;
  background:#00ff8c;
  transition:width .15s linear;
}

audio{
  width:100%;
  margin-top:12px;
}

.controls{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:13px;
}

#metronomoContainer{
  display:none;
  gap:8px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:10px;
}

#metronomoContainer input{
  width:70px;
  background:#111;
  border:none;
  color:#fff;
  padding:6px;
  border-radius:8px;
  text-align:center;
}

#labelTom,#labelVel{
  text-align:center;
  font-size:14px;
  margin-top:6px;
  color:var(--muted);
}

#playerView,#transposeView{display:none;}
</style>
</head>

<body>
<div class="app">

<div class="top-menu">
  <button onclick="mostrarPlayer()">üéµ Player</button>
  <button onclick="mostrarTranspose()">üéß Transpose</button>
</div>

<!-- ================= PLAYER ================= -->

<div id="playerView" class="card">

<h1>Player</h1>

<div class="buttons">
  <button onclick="fileInput.click()">üìÅ Carregar m√∫sicas</button>
</div>

<input type="file" id="fileInput" accept="audio/*" multiple hidden>

<div id="musicList"></div>

<audio id="audioPlayer" controls></audio>

<div id="metronomoContainer">
  <button id="btnMenosBPM">‚àí</button>
  <button id="btnMetronomo">üéµ Metr√¥nomo OFF</button>
  <button id="btnMaisBPM">+</button>
  <input type="number" id="inputBPM" value="60" min="40" max="200">
</div>

<h3 style="text-align:center;cursor:pointer;color:#1db954" onclick="alternarAvancado()">üéõÔ∏è Avan√ßado</h3>

<div id="avancado" class="buttons" style="display:none">
  <button onclick="marcarInicioLoop()">‚ñ∂ In√≠cio</button>
  <button onclick="marcarFimLoop()">‚èπ Fim</button>
  <button onclick="desativarTrechoLoop()">‚õî Loop trecho</button>
  <button id="btnLoopGeral" onclick="toggleLoopGeral()">üîÅ Lista OFF</button>
  <button id="btnLoopMusica" onclick="toggleLoopMusica()">üîÇ M√∫sica OFF</button>
  <button id="btnVel" onclick="alternarVelocidade()">‚è© 1x</button>
</div>

<div id="equalizador" class="controls" style="display:none">
  Grave <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(0,this.value)">
  M√©dio <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(1,this.value)">
  Agudo <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(2,this.value)">
</div>

</div>

<!-- ================= TRANSPOSE ================= -->

<div id="transposeView" class="card">

<h1>Transpose Player</h1>

<label>
Selecionar m√∫sica:
<input type="file" id="fileInputT" accept="audio/*">
</label>

<audio id="originalAudio" controls></audio>
<audio id="transposedAudio" controls style="display:none"></audio>

<div class="buttons">
  <button onclick="tomDown()">‚àí Tom</button>
  <button onclick="tomUp()">+ Tom</button>
  <button onclick="processarTranspose()">‚ñ∂ Processar</button>
</div>

<div id="labelTom">Tom atual: 0</div>

<div class="buttons">
  <button onclick="velDown()">‚àí Vel</button>
  <button onclick="velUp()">+ Vel</button>
</div>

<div id="labelVel">Velocidade: 1.00x</div>

<div class="buttons">
  <button onclick="loopIniT()">üéØ In√≠cio</button>
  <button onclick="loopFimT()">üîÅ Fim</button>
  <button onclick="resetLoopT()">‚õî Reset</button>
</div>

<div id="downloadSection" style="display:none" class="buttons">
  <button onclick="baixarT()">‚¨á Baixar</button>
  <button onclick="compartilharT()">üì§ Compartilhar</button>
</div>

</div>

<script>
/* ---------------- Navega√ß√£o ---------------- */

function mostrarPlayer(){
  playerView.style.display="block";
  transposeView.style.display="none";
}

function mostrarTranspose(){
  playerView.style.display="none";
  transposeView.style.display="block";
}

mostrarPlayer();

/* ===================== PLAYER ===================== */

const fileInput=document.getElementById("fileInput");
const musicList=document.getElementById("musicList");
const audioPlayer=document.getElementById("audioPlayer");

let musicas=[];
let musicaAtual=0;
let repetirLista=false;
let repetirMusica=false;

fileInput.onchange=e=>{
  for(const f of e.target.files){
    musicas.push({nome:f.name,url:URL.createObjectURL(f)});
  }
  montarLista();
  if(musicas.length) tocar(0);
};

function montarLista(){
  musicList.innerHTML="";
  musicas.forEach((m,i)=>{
    let autor="",titulo=m.nome;
    if(titulo.includes(" - ")){
      [autor,titulo]=titulo.split(" - ");
    }
    titulo=titulo.replace(/\.[^/.]+$/,"");

    const d=document.createElement("div");
    d.className="music-item";
    d.dataset.index=i;

    d.innerHTML=`
      <div class="music-title">${titulo}</div>
      <div class="music-author">${autor}</div>
      <div class="item-progress"></div>
    `;

    d.onclick=()=>tocar(i);
    musicList.appendChild(d);
  });
}

function marcarItemAtual(){
  document.querySelectorAll(".music-item").forEach(el=>{
    el.classList.toggle(
      "playing",
      parseInt(el.dataset.index)==musicaAtual
    );
  });
}

function tocar(i){
  musicaAtual=i;
  audioPlayer.src=musicas[i].url;
  audioPlayer.loop=repetirMusica;
  audioPlayer.play();
  loopAtivo=false;
  loopInicio=0;
  loopFim=0;
  marcarItemAtual();
}

audioPlayer.ontimeupdate=()=>{
  if(loopAtivo && audioPlayer.currentTime>=loopFim){
    audioPlayer.currentTime=loopInicio;
  }

  const item=document.querySelector('.music-item[data-index="'+musicaAtual+'"]');
  if(item && audioPlayer.duration){
    const p=item.querySelector(".item-progress");
    p.style.width=(audioPlayer.currentTime/audioPlayer.duration*100)+"%";
  }
};

audioPlayer.onended=()=>{
  const item=document.querySelector('.music-item[data-index="'+musicaAtual+'"]');
  if(item)item.querySelector(".item-progress").style.width="0%";

  if(repetirMusica)return;
  if(repetirLista){
    musicaAtual=(musicaAtual+1)%musicas.length;
    tocar(musicaAtual);
  }else if(musicaAtual+1<musicas.length){
    musicaAtual++;
    tocar(musicaAtual);
  }
};

function toggleLoopGeral(){
  repetirLista=!repetirLista;
  btnLoopGeral.textContent=repetirLista?"üîÅ Lista ON":"üîÅ Lista OFF";
}

function toggleLoopMusica(){
  repetirMusica=!repetirMusica;
  audioPlayer.loop=repetirMusica;
  btnLoopMusica.textContent=repetirMusica?"üîÇ M√∫sica ON":"üîÇ M√∫sica OFF";
}

/* ----- EQ ----- */

let ctxEQ,srcEQ,filtersEQ=[],gainEQ;

function initEQ(){
  if(ctxEQ)return;
  ctxEQ=new AudioContext();
  srcEQ=ctxEQ.createMediaElementSource(audioPlayer);
  gainEQ=ctxEQ.createGain();
  const f=[60,1000,5000];
  filtersEQ=f.map(fr=>{
    const fl=ctxEQ.createBiquadFilter();
    fl.type="peaking";
    fl.frequency.value=fr;
    fl.Q.value=1;
    fl.gain.value=0;
    return fl;
  });
  srcEQ.connect(filtersEQ[0]);
  filtersEQ.reduce((a,b)=>(a.connect(b),b));
  filtersEQ.at(-1).connect(gainEQ);
  gainEQ.connect(ctxEQ.destination);
}

function ajustarEQ(i,v){
  initEQ();
  filtersEQ[i].gain.value=parseFloat(v);
}

/* ----- Loop trecho ----- */

let loopInicio=0,loopFim=0,loopAtivo=false;

function marcarInicioLoop(){loopInicio=audioPlayer.currentTime;}
function marcarFimLoop(){
  if(!loopInicio)return;
  loopFim=audioPlayer.currentTime;
  if(loopFim>loopInicio)loopAtivo=true;
}
function desativarTrechoLoop(){
  loopAtivo=false;loopInicio=0;loopFim=0;
}

/* ----- Velocidade ----- */

const velocidades=[0.5,0.75,1,1.25,1.5,2];
let velIdx=2;

function alternarVelocidade(){
  velIdx=(velIdx+1)%velocidades.length;
  const v=velocidades[velIdx];
  audioPlayer.playbackRate=v;
  btnVel.textContent="‚è© "+v+"x";
}

/* ----- Avan√ßado ----- */

function alternarAvancado(){
  const a=avancado.style.display==="flex";
  avancado.style.display=a?"none":"flex";
  equalizador.style.display=a?"none":"block";
  metronomoContainer.style.display=a?"none":"flex";
}

/* ----- Metr√¥nomo ----- */

let bpm=60,metAtivo=false,metInt=null,metCtx;

function clique(){
  const o=metCtx.createOscillator();
  const g=metCtx.createGain();
  o.frequency.value=1000;
  g.gain.setValueAtTime(1,metCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,metCtx.currentTime+0.05);
  o.connect(g);g.connect(metCtx.destination);
  o.start();o.stop(metCtx.currentTime+0.05);
}

function iniciarMet(){
  clearInterval(metInt);
  clique();
  metInt=setInterval(clique,60000/bpm);
}

btnMetronomo.onclick=()=>{
  if(!metCtx)metCtx=new AudioContext();
  metAtivo=!metAtivo;
  if(metAtivo){
    iniciarMet();
    btnMetronomo.textContent="üéµ ON ("+bpm+")";
  }else{
    clearInterval(metInt);
    btnMetronomo.textContent="üéµ OFF";
  }
};

inputBPM.onchange=()=>{
  bpm=Math.min(200,Math.max(40,parseInt(inputBPM.value)||60));
  inputBPM.value=bpm;
  if(metAtivo)iniciarMet();
};

btnMaisBPM.onclick=()=>{if(bpm<200){bpm++;inputBPM.value=bpm;if(metAtivo)iniciarMet();}};
btnMenosBPM.onclick=()=>{if(bpm>40){bpm--;inputBPM.value=bpm;if(metAtivo)iniciarMet();}};

/* ===================== TRANSPOSE ===================== */

let ctxT,bufferT=null,transpose=0,velT=1;
let blobURL=null;
let loopIni=null,loopFim2=null,loopAtivoT=false;

fileInputT.onchange=async()=>{
  const f=fileInputT.files[0];
  if(!f)return;
  ctxT=new AudioContext();
  const ab=await f.arrayBuffer();
  bufferT=await ctxT.decodeAudioData(ab);
  originalAudio.src=URL.createObjectURL(f);
  atualizarLabelsT();
};

function tomUp(){transpose++;atualizarLabelsT();}
function tomDown(){transpose--;atualizarLabelsT();}

function velUp(){velT=Math.min(4,velT+0.25);atualizarLabelsT();}
function velDown(){velT=Math.max(0.25,velT-0.25);atualizarLabelsT();}

function atualizarLabelsT(){
  labelTom.textContent="Tom atual: "+transpose;
  labelVel.textContent="Velocidade: "+velT.toFixed(2)+"x";
  originalAudio.playbackRate=velT;
  transposedAudio.playbackRate=velT;
}

async function processarTranspose(){
  if(!bufferT)return alert("Selecione um √°udio");

  const off=new OfflineAudioContext(
    bufferT.numberOfChannels,
    bufferT.length,
    bufferT.sampleRate
  );

  const s=off.createBufferSource();
  s.buffer=bufferT;
  s.playbackRate.value=Math.pow(2,transpose/12);
  s.connect(off.destination);
  s.start();

  const r=await off.startRendering();
  const wav=bufferToWav(r);
  const blob=new Blob([new DataView(wav)],{type:"audio/wav"});
  blobURL=URL.createObjectURL(blob);

  transposedAudio.src=blobURL;
  transposedAudio.style.display="block";
  transposedAudio.playbackRate=velT;
  transposedAudio.play();
  downloadSection.style.display="flex";
}

function baixarT(){
  if(!blobURL)return;
  const a=document.createElement("a");
  a.href=blobURL;
  a.download="audio_transposto.wav";
  a.click();
}

function compartilharT(){
  if(!blobURL)return;
  const msg=encodeURIComponent("Ou√ßa esse √°udio: "+blobURL);
  window.open("https://wa.me/?text="+msg,"_blank");
}

function loopIniT(){loopIni=transposedAudio.currentTime;}
function loopFimT(){
  if(loopIni==null)return;
  loopFim2=transposedAudio.currentTime;
  if(loopFim2>loopIni)loopAtivoT=true;
}
function resetLoopT(){
  loopIni=null;loopFim2=null;loopAtivoT=false;
}

transposedAudio.ontimeupdate=()=>{
  if(loopAtivoT && transposedAudio.currentTime>=loopFim2){
    transposedAudio.currentTime=loopIni;
  }
};

/* ----- WAV ----- */

function bufferToWav(buffer){
  let num=buffer.numberOfChannels,
  len=buffer.length*num*2+44,
  ab=new ArrayBuffer(len),
  view=new DataView(ab),
  ch=[],pos=0,off=0;

  function u16(d){view.setUint16(pos,d,true);pos+=2;}
  function u32(d){view.setUint32(pos,d,true);pos+=4;}

  u32(0x46464952);u32(len-8);u32(0x45564157);
  u32(0x20746d66);u32(16);u16(1);u16(num);
  u32(buffer.sampleRate);
  u32(buffer.sampleRate*2*num);
  u16(num*2);u16(16);
  u32(0x61746164);u32(len-pos-4);

  for(let i=0;i<num;i++)ch.push(buffer.getChannelData(i));

  while(pos<len){
    for(let i=0;i<num;i++){
      let s=Math.max(-1,Math.min(1,ch[i][off]));
      view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);
      pos+=2;
    }
    off++;
  }
  return ab;
}
</script>

<button id="btnInstall" style="display:none;">üì≤ Instalar App</button>

<script>
let deferredPrompt;
const btnInstall = document.getElementById("btnInstall");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "block";
});

btnInstall.addEventListener("click", async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btnInstall.style.display = "none";
  }
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</div>
</body>
</html>
