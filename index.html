<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Player Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:'Segoe UI',Tahoma,sans-serif;
  background:#121212;
  color:#eee;
  padding:15px;
  max-width:700px;
  margin:auto;
}

h1{text-align:center;color:#00b0ff}

.buttons{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:15px;
}

button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#000;
  color:#fff;
}

button:hover{background:#00b0ff}

#musicList{
  display:flex;
  flex-direction:column;
  gap:10px;
  max-height:350px;
  overflow-y:auto;
}

.music-item{
  background:#222;
  padding:10px;
  border-radius:10px;
  cursor:pointer;
}

.music-item:hover{background:#1db954;color:#111}

.music-title{font-weight:bold}
.music-author{font-size:13px;color:#aaa}

audio{width:100%;margin-top:15px}

.controls{text-align:center;margin-top:10px}

#metronomoContainer{
  display:none;
  justify-content:center;
  gap:10px;
  margin-top:10px;
}

#metronomoContainer input{width:60px}

#playerView,#transposeView{display:none}
</style>
</head>
<body>

<div class="buttons">
  <button onclick="mostrarPlayer()">ğŸµ Player</button>
  <button onclick="mostrarTranspose()">ğŸ§ Transpose</button>
</div>

<!-- ================= PLAYER ================= -->

<div id="playerView">

<h1>Player</h1>

<div class="buttons">
  <button onclick="fileInput.click()">ğŸ“ Carregar mÃºsicas</button>
</div>

<input type="file" id="fileInput" accept="audio/*" multiple hidden>

<div id="musicList"></div>

<audio id="audioPlayer" controls></audio>

<div id="metronomoContainer">
  <button id="btnMenosBPM">âˆ’</button>
  <button id="btnMetronomo">ğŸµ MetrÃ´nomo OFF</button>
  <button id="btnMaisBPM">+</button>
  <input type="number" id="inputBPM" value="60" min="40" max="200">
</div>

<h3 style="text-align:center;cursor:pointer;color:#1db954" onclick="alternarAvancado()">ğŸ›ï¸ AvanÃ§ado</h3>

<div id="avancado" class="buttons" style="display:none">
  <button onclick="marcarInicioLoop()">â–¶ InÃ­cio</button>
  <button onclick="marcarFimLoop()">â¹ Fim</button>
  <button onclick="desativarTrechoLoop()">â›” Loop trecho</button>
  <button id="btnLoopGeral" onclick="toggleLoopGeral()">ğŸ” Lista OFF</button>
  <button id="btnLoopMusica" onclick="toggleLoopMusica()">ğŸ”‚ MÃºsica OFF</button>
  <button id="btnVel" onclick="alternarVelocidade()">â© 1x</button>
</div>

<div id="equalizador" class="controls" style="display:none">
  Grave <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(0,this.value)">
  MÃ©dio <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(1,this.value)">
  Agudo <input type="range" min="-30" max="30" value="0" oninput="ajustarEQ(2,this.value)">
</div>

</div>

<!-- ================= TRANSPOSE ================= -->

<div id="transposeView">

<h1>Transpose Player</h1>

<label>
Selecionar mÃºsica:
<input type="file" id="fileInputT" accept="audio/*">
</label>

<audio id="originalAudio" controls></audio>
<audio id="transposedAudio" controls style="display:none"></audio>

<div class="buttons">
  <button onclick="tomDown()">âˆ’ Tom</button>
  <button onclick="tomUp()">+ Tom</button>
  <button onclick="processarTranspose()">â–¶ Processar</button>
</div>

<div id="labelTom">Tom atual: 0</div>

<div class="buttons">
  <button onclick="velDown()">âˆ’ Vel</button>
  <button onclick="velUp()">+ Vel</button>
</div>

<div id="labelVel">Velocidade: 1.00x</div>

<div class="buttons">
  <button onclick="loopIniT()">ğŸ¯ InÃ­cio</button>
  <button onclick="loopFimT()">ğŸ” Fim</button>
  <button onclick="resetLoopT()">â›” Reset</button>
</div>

<div id="downloadSection" style="display:none" class="buttons">
  <button onclick="baixarT()">â¬‡ Baixar</button>
  <button onclick="compartilharT()">ğŸ“¤ Compartilhar</button>
</div>

</div>

<script>
/* ---------------- NavegaÃ§Ã£o ---------------- */

function mostrarPlayer(){
  playerView.style.display="block";
  transposeView.style.display="none";
}

function mostrarTranspose(){
  playerView.style.display="none";
  transposeView.style.display="block";
}

mostrarPlayer();

/* ===================== PLAYER ===================== */

const fileInput=document.getElementById("fileInput");
const musicList=document.getElementById("musicList");
const audioPlayer=document.getElementById("audioPlayer");

let musicas=[];
let musicaAtual=0;
let repetirLista=false;
let repetirMusica=false;

fileInput.onchange=e=>{
  for(const f of e.target.files){
    musicas.push({nome:f.name,url:URL.createObjectURL(f)});
  }
  montarLista();
  if(musicas.length) tocar(0);
};

function montarLista(){
  musicList.innerHTML="";
  musicas.forEach((m,i)=>{
    let autor="",titulo=m.nome;
    if(titulo.includes(" - ")){
      [autor,titulo]=titulo.split(" - ");
    }
    titulo=titulo.replace(/\.[^/.]+$/,"");
    const d=document.createElement("div");
    d.className="music-item";
    d.innerHTML=`<div class="music-title">${titulo}</div>
                 <div class="music-author">${autor}</div>`;
    d.onclick=()=>tocar(i);
    musicList.appendChild(d);
  });
}

function tocar(i){
  musicaAtual=i;
  audioPlayer.src=musicas[i].url;
  audioPlayer.loop=repetirMusica;
  audioPlayer.play();
  loopAtivo=false;
  loopInicio=0;
  loopFim=0;
}

audioPlayer.onended=()=>{
  if(repetirMusica)return;
  if(repetirLista){
    musicaAtual=(musicaAtual+1)%musicas.length;
    tocar(musicaAtual);
  }else if(musicaAtual+1<musicas.length){
    musicaAtual++;
    tocar(musicaAtual);
  }
};

function toggleLoopGeral(){
  repetirLista=!repetirLista;
  btnLoopGeral.textContent=repetirLista?"ğŸ” Lista ON":"ğŸ” Lista OFF";
}

function toggleLoopMusica(){
  repetirMusica=!repetirMusica;
  audioPlayer.loop=repetirMusica;
  btnLoopMusica.textContent=repetirMusica?"ğŸ”‚ MÃºsica ON":"ğŸ”‚ MÃºsica OFF";
}

/* ----- EQ ----- */

let ctxEQ,srcEQ,filtersEQ=[],gainEQ;

function initEQ(){
  if(ctxEQ)return;
  ctxEQ=new AudioContext();
  srcEQ=ctxEQ.createMediaElementSource(audioPlayer);
  gainEQ=ctxEQ.createGain();
  const f=[60,1000,5000];
  filtersEQ=f.map(fr=>{
    const fl=ctxEQ.createBiquadFilter();
    fl.type="peaking";
    fl.frequency.value=fr;
    fl.Q.value=1;
    fl.gain.value=0;
    return fl;
  });
  srcEQ.connect(filtersEQ[0]);
  filtersEQ.reduce((a,b)=>(a.connect(b),b));
  filtersEQ.at(-1).connect(gainEQ);
  gainEQ.connect(ctxEQ.destination);
}

function ajustarEQ(i,v){
  initEQ();
  filtersEQ[i].gain.value=parseFloat(v);
}

/* ----- Loop trecho ----- */

let loopInicio=0,loopFim=0,loopAtivo=false;

function marcarInicioLoop(){
  loopInicio=audioPlayer.currentTime;
}

function marcarFimLoop(){
  if(!loopInicio)return;
  loopFim=audioPlayer.currentTime;
  if(loopFim>loopInicio)loopAtivo=true;
}

function desativarTrechoLoop(){
  loopAtivo=false;loopInicio=0;loopFim=0;
}

audioPlayer.ontimeupdate=()=>{
  if(loopAtivo && audioPlayer.currentTime>=loopFim){
    audioPlayer.currentTime=loopInicio;
  }
};

/* ----- Velocidade ----- */

const velocidades=[0.5,0.75,1,1.25,1.5,2];
let velIdx=2;

function alternarVelocidade(){
  velIdx=(velIdx+1)%velocidades.length;
  const v=velocidades[velIdx];
  audioPlayer.playbackRate=v;
  btnVel.textContent="â© "+v+"x";
}

/* ----- AvanÃ§ado ----- */

function alternarAvancado(){
  const a=avancado.style.display==="flex";
  avancado.style.display=a?"none":"flex";
  equalizador.style.display=a?"none":"block";
  metronomoContainer.style.display=a?"none":"flex";
}

/* ----- MetrÃ´nomo ----- */

let bpm=60,metAtivo=false,metInt=null,metCtx;

function clique(){
  const o=metCtx.createOscillator();
  const g=metCtx.createGain();
  o.frequency.value=1000;
  g.gain.setValueAtTime(1,metCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,metCtx.currentTime+0.05);
  o.connect(g);g.connect(metCtx.destination);
  o.start();o.stop(metCtx.currentTime+0.05);
}

function iniciarMet(){
  clearInterval(metInt);
  clique();
  metInt=setInterval(clique,60000/bpm);
}

btnMetronomo.onclick=()=>{
  if(!metCtx)metCtx=new AudioContext();
  metAtivo=!metAtivo;
  if(metAtivo){
    iniciarMet();
    btnMetronomo.textContent="ğŸµ ON ("+bpm+")";
  }else{
    clearInterval(metInt);
    btnMetronomo.textContent="ğŸµ OFF";
  }
};

inputBPM.onchange=()=>{
  bpm=Math.min(200,Math.max(40,parseInt(inputBPM.value)||60));
  inputBPM.value=bpm;
  if(metAtivo)iniciarMet();
};

btnMaisBPM.onclick=()=>{if(bpm<200){bpm++;inputBPM.value=bpm;if(metAtivo)iniciarMet();}};
btnMenosBPM.onclick=()=>{if(bpm>40){bpm--;inputBPM.value=bpm;if(metAtivo)iniciarMet();}};

/* ===================== TRANSPOSE ===================== */

let ctxT,bufferT=null,transpose=0,velT=1;
let blobURL=null;
let loopIni=null,loopFim2=null,loopAtivoT=false;

fileInputT.onchange=async()=>{
  const f=fileInputT.files[0];
  if(!f)return;
  ctxT=new AudioContext();
  const ab=await f.arrayBuffer();
  bufferT=await ctxT.decodeAudioData(ab);
  originalAudio.src=URL.createObjectURL(f);
  atualizarLabelsT();
};

function tomUp(){transpose++;atualizarLabelsT();}
function tomDown(){transpose--;atualizarLabelsT();}

function velUp(){velT=Math.min(4,velT+0.25);atualizarLabelsT();}
function velDown(){velT=Math.max(0.25,velT-0.25);atualizarLabelsT();}

function atualizarLabelsT(){
  labelTom.textContent="Tom atual: "+transpose;
  labelVel.textContent="Velocidade: "+velT.toFixed(2)+"x";
  originalAudio.playbackRate=velT;
  transposedAudio.playbackRate=velT;
}

async function processarTranspose(){
  if(!bufferT)return alert("Selecione um Ã¡udio");

  const off=new OfflineAudioContext(
    bufferT.numberOfChannels,
    bufferT.length,
    bufferT.sampleRate
  );

  const s=off.createBufferSource();
  s.buffer=bufferT;
  s.playbackRate.value=Math.pow(2,transpose/12);
  s.connect(off.destination);
  s.start();

  const r=await off.startRendering();
  const wav=bufferToWav(r);
  const blob=new Blob([new DataView(wav)],{type:"audio/wav"});
  blobURL=URL.createObjectURL(blob);

  transposedAudio.src=blobURL;
  transposedAudio.style.display="block";
  transposedAudio.playbackRate=velT;
  transposedAudio.play();
  downloadSection.style.display="flex";
}

function baixarT(){
  if(!blobURL)return;
  const a=document.createElement("a");
  a.href=blobURL;
  a.download="audio_transposto.wav";
  a.click();
}

function compartilharT(){
  if(!blobURL)return;
  const msg=encodeURIComponent("OuÃ§a esse Ã¡udio: "+blobURL);
  window.open("https://wa.me/?text="+msg,"_blank");
}

function loopIniT(){loopIni=transposedAudio.currentTime;}
function loopFimT(){
  if(loopIni==null)return;
  loopFim2=transposedAudio.currentTime;
  if(loopFim2>loopIni)loopAtivoT=true;
}
function resetLoopT(){
  loopIni=null;loopFim2=null;loopAtivoT=false;
}

transposedAudio.ontimeupdate=()=>{
  if(loopAtivoT && transposedAudio.currentTime>=loopFim2){
    transposedAudio.currentTime=loopIni;
  }
};

/* ----- WAV ----- */

function bufferToWav(buffer){
  let num=buffer.numberOfChannels,
  len=buffer.length*num*2+44,
  ab=new ArrayBuffer(len),
  view=new DataView(ab),
  ch=[],pos=0,off=0;

  function u16(d){view.setUint16(pos,d,true);pos+=2;}
  function u32(d){view.setUint32(pos,d,true);pos+=4;}

  u32(0x46464952);u32(len-8);u32(0x45564157);
  u32(0x20746d66);u32(16);u16(1);u16(num);
  u32(buffer.sampleRate);
  u32(buffer.sampleRate*2*num);
  u16(num*2);u16(16);
  u32(0x61746164);u32(len-pos-4);

  for(let i=0;i<num;i++)ch.push(buffer.getChannelData(i));

  while(pos<len){
    for(let i=0;i<num;i++){
      let s=Math.max(-1,Math.min(1,ch[i][off]));
      view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);
      pos+=2;
    }
    off++;
  }
  return ab;
}
</script>

</body>
</html>
